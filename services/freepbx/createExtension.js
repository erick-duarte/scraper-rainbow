const axios = require('axios');
const { config } = require('../../config/config');
const querystring = require('querystring');

async function createExtension(extension, name, password, phpSessId) {
    const response = await axios.post(
        `http://${config.ip_freepbx}/admin/config.php?display=extensions`,
        querystring.stringify({
            action: 'add',
            extdisplay: '',
            tech: 'pjsip',
            hardware: 'generic',
            extension: extension,
            name: name,
            outboundcid: '',
            emergency_cid: '',
            devinfo_secret: password,
            langcode: '',
            userman_directory: 1,
            userman_assign: 'add',
            userman_password: '1eaa3f83fee4cdda5ca35f897d1f58d2',
            // userman_group[]: 1,
            vm: 'disabled',
            vmx_option_0_number: '',
            vmx_option_0_system_default: 'checked',
            fmfm_ddial: 'disabled',
            fmfm_pre_ring: 7,
            fmfm_strategy: 'ringallv2-prim',
            fmfm_grptime: 20,
            fmfm_grplist: '',
            fmfm_annmsg_id: '',
            fmfm_ringing: 'Ring',
            fmfm_grppre: '',
            fmfm_dring: '',
            fmfm_rvolume: '',
            fmfm_needsconf: 'disabled',
            fmfm_changecid: 'default',
            gotofmfm: 'Follow_Me',
            Feature_Code_Adminfmfm: 'ext-featurecodes,*38,1',
            Announcementsfmfm: 'popover',
            Custom_Applicationsfmfm: 'popover',
            Call_Recordingfmfm: 'popover',
            Callbackfmfm: 'popover',
            Time_Conditionsfmfm: 'popover',
            Conference_Profmfm: 'popover',
            Conferencesfmfm: 'popover',
            Call_Flow_Controlfmfm: 'popover',
            Voicemail_Blastingfmfm: 'popover',
            DISAfmfm: 'popover',
            Misc_Destinationsfmfm: 'popover',
            Directoryfmfm: 'popover',
            Dynamic_Routesfmfm: 'popover',
            Fax_Recipientfmfm: 'ext-fax,3,1',
            Queuesfmfm: 'popover',
            Ring_Groupsfmfm: 'popover',
            Languagesfmfm: 'popover',
            Paging_and_Intercomfmfm: 'popover',
            Queue_Prioritiesfmfm: 'popover',
            Queues_Profmfm: 'popover',
            Extensionsfmfm: 'from-did-direct,6107,1',
            Inbound_Routesfmfm: 'popover',
            Follow_Mefmfm: 'ext-local,,dest',
            Sipstationfmfm: 'sipstation-welcome,${EXTEN},1',
            Terminate_Callfmfm: 'app-blackhole,hangup,1',
            Text_To_Speechfmfm: 'popover',
            Trunksfmfm: 'popover',
            IVRfmfm: 'popover',
            Voipinnovationsfmfm: 'voipinnovations-welcome,${EXTEN},1',
            fmfm_goto: 'gotofmfm',
            newdid_name: '',
            newdid: '',
            newdidcid: '',
            devinfo_dtmfmode: 'rfc4733',
            devinfo_context: 'from-internal',
            devinfo_defaultuser: '',
            devinfo_trustrpid: 'yes',
            devinfo_send_connected_line: 'yes',
            devinfo_user_eq_phone: 'no',
            devinfo_sendrpid: 'pai',
            devinfo_qualifyfreq: 60,
            devinfo_transport: '',
            devinfo_avpf: 'no',
            devinfo_icesupport: 'no',
            devinfo_rtcp_mux: 'no',
            devinfo_namedcallgroup: '',
            devinfo_namedpickupgroup: '',
            devinfo_disallow: '',
            devinfo_allow: '',
            devinfo_dial: '',
            devinfo_mailbox: '',
            devinfo_vmexten: '',
            devinfo_accountcode: '',
            devinfo_max_contacts: 1,
            devinfo_remove_existing: 'no',
            devinfo_media_use_received_transport: 'no',
            devinfo_rtp_symmetric: 'yes',
            devinfo_rewrite_contact: 'yes',
            devinfo_force_rport: 'yes',
            devinfo_mwi_subscription: 'auto',
            devinfo_aggregate_mwi: 'yes',
            devinfo_bundle: 'no',
            devinfo_max_audio_streams: 1,
            devinfo_max_video_streams: 1,
            devinfo_media_encryption: 'sdes',
            devinfo_timers: 'yes',
            devinfo_timers_min_se: 90,
            devinfo_direct_media: 'yes',
            devinfo_media_encryption_optimistic: 'no',
            devinfo_refer_blind_progress: 'yes',
            devinfo_device_state_busy_at: 0,
            devinfo_match: '',
            devinfo_maximum_expiration: 7200,
            devinfo_minimum_expiration: 60,
            devinfo_rtp_timeout: 0,
            devinfo_rtp_timeout_hold: 0,
            devinfo_outbound_proxy: '',
            devinfo_message_context: '',
            cid_masquerade: '',
            sipname: '',
            ringtimer: 0,
            rvolume: '',
            cfringtimer: 0,
            concurrency_limit: 3,
            callwaiting: 'enabled',
            cwtone: 'disabled',
            call_screen: 0,
            recording_in_external: 'dontcare',
            recording_out_external: 'dontcare',
            recording_in_internal: 'dontcare',
            recording_out_internal: 'dontcare',
            recording_ondemand: 'disabled',
            recording_priority: 10,
            dictenabled: 'disabled',
            dictformat: 'ogg',
            dictemail: '',
            dictfrom: 'dictate@freepbx.org',
            in_default_directory: 0,
            intercom: 'enabled',
            qnostate: 'usestate',
            dtls_enable: 'no',
            dtls_auto_generate_cert: 0,
            dtls_certificate: 2,
            dtls_verify: 'fingerprint',
            dtls_setup: 'actpass',
            dtls_rekey: 0,
            goto0: '',
            Feature_Code_Admin0: 'ext-featurecodes,*38,1',
            Announcements0: 'popover',
            Custom_Applications0: 'popover',
            Call_Recording0: 'popover',
            Callback0: 'popover',
            Time_Conditions0: 'popover',
            Conference_Pro0: 'popover',
            Conferences0: 'popover',
            Call_Flow_Control0: 'popover',
            Voicemail_Blasting0: 'popover',
            DISA0: 'popover',
            Misc_Destinations0: 'popover',
            Directory0: 'popover',
            Dynamic_Routes0: 'popover',
            Fax_Recipient0: 'ext-fax,3,1',
            Queues0: 'popover',
            Ring_Groups0: 'popover',
            Languages0: 'popover',
            Paging_and_Intercom0: 'popover',
            Queue_Priorities0: 'popover',
            Queues_Pro0: 'popover',
            Extensions0: 'from-did-direct,6107,1',
            Inbound_Routes0: 'popover',
            Sipstation0: 'sipstation-welcome,${EXTEN},1',
            Terminate_Call0: 'app-blackhole,hangup,1',
            Text_To_Speech0: 'popover',
            Trunks0: 'popover',
            IVR0: 'popover',
            Voipinnovations0: 'voipinnovations-welcome,${EXTEN},1',
            noanswer_dest: 'goto0',
            noanswer_cid: '',
            goto1: '',
            Feature_Code_Admin1: 'ext-featurecodes,*38,1',
            Announcements1: 'popover',
            Custom_Applications1: 'popover',
            Call_Recording1: 'popover',
            Callback1: 'popover',
            Time_Conditions1: 'popover',
            Conference_Pro1: 'popover',
            Conferences1: 'popover',
            Call_Flow_Control1: 'popover',
            Voicemail_Blasting1: 'popover',
            DISA1: 'popover',
            Misc_Destinations1: 'popover',
            Directory1: 'popover',
            Dynamic_Routes1: 'popover',
            Fax_Recipient1: 'ext-fax,3,1',
            Queues1: 'popover',
            Ring_Groups1: 'popover',
            Languages1: 'popover',
            Paging_and_Intercom1: 'popover',
            Queue_Priorities1: 'popover',
            Queues_Pro1: 'popover',
            Extensions1: 'from-did-direct,6107,1',
            Inbound_Routes1: 'popover',
            Sipstation1: 'sipstation-welcome,${EXTEN},1',
            Terminate_Call1: 'app-blackhole,hangup,1',
            Text_To_Speech1: 'popover',
            Trunks1: 'popover',
            IVR1: 'popover',
            Voipinnovations1: 'voipinnovations-welcome,${EXTEN},1',
            busy_dest: 'goto1',
            busy_cid: '',
            goto2: '',
            Feature_Code_Admin2: 'ext-featurecodes,*38,1',
            Announcements2: 'popover',
            Custom_Applications2: 'popover',
            Call_Recording2: 'popover',
            Callback2: 'popover',
            Time_Conditions2: 'popover',
            Conference_Pro2: 'popover',
            Conferences2: 'popover',
            Call_Flow_Control2: 'popover',
            Voicemail_Blasting2: 'popover',
            DISA2: 'popover',
            Misc_Destinations2: 'popover',
            Directory2: 'popover',
            Dynamic_Routes2: 'popover',
            Fax_Recipient2: 'ext-fax,3,1',
            Queues2: 'popover',
            Ring_Groups2: 'popover',
            Languages2: 'popover',
            Paging_and_Intercom2: 'popover',
            Queue_Priorities2: 'popover',
            Queues_Pro2: 'popover',
            Extensions2: 'from-did-direct,6107,1',
            Inbound_Routes2: 'popover',
            Sipstation2: 'sipstation-welcome,${EXTEN},1',
            Terminate_Call2: 'app-blackhole,hangup,1',
            Text_To_Speech2: 'popover',
            Trunks2: 'popover',
            IVR2: 'popover',
            Voipinnovations2: 'voipinnovations-welcome,${EXTEN},1',
            chanunavail_dest: 'goto2',
            chanunavail_cid: '',
            pinless: 'disabled',
            cxpanel_add_extension: 1,
            cxpanel_auto_answer: 0,
            intercom_override: 'reject',
            devinfo_secret_origional: '',
            devinfo_sipdriver: 'chan_pjsip'
        }),
        {
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Cookie': `PHPSESSID=${phpSessId}`,
                'Referer': `http://${config.ip_freepbx}/admin/config.php?display=extensions&tech_hardware=pjsip_generic`
            }
        }
    );
    return response.status;
}

module.exports = { createExtension }